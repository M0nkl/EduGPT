from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from models import Base, Methodic
import os

# Создаем движок для SQLite
SQLALCHEMY_DATABASE_URL = "sqlite:///./data/methodics.db"

engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={"check_same_thread": False}
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)


def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


def init_db():
    # Создаем таблицы
    Base.metadata.create_all(bind=engine)

    # Добавляем тестовые данные, если таблица пустая
    db = SessionLocal()
    try:
        if db.query(Methodic).count() == 0:
            add_sample_data(db)
    finally:
        db.close()


def add_sample_data(db: SessionLocal):
    """Добавляем примеры методичек на основе вашего PDF"""

    sample_methodics = [
        Methodic(
            title="Сообщества практик будущего в университетах",
            content="""В статье рассматриваются университетские сообщества технологических энтузиастов: фаблабы, ЦМИТы, кружки. 
            Основная концептуальная рамка исследования - теория полей, которая утверждает, что общество - это система взаимодействующих 
            и вложенных друг в друга социальных полей, а его изменения - это трансформация существующих социальных полей или возникновение новых.

            Выявлены четыре основные стратегии технологических энтузиастов:
            1. Стратегия 'прийти в гараж' - поддержка инициативных
            2. Стратегия 'свечи перед пультом' - проектное мышление
            3. Стратегия 'чуткая сложность' - поддержка разнообразия
            4. Стратегия 'невидимое лидерство' - горизонтальная организация и меритократия""",
            subject="Высшее образование",
            author="Земцов Д.И."
        ),
        Methodic(
            title="Фаблабы и ЦМИТы как инновационные площадки",
            content="""Фаблабы - это глобальная сеть лабораторий, способствующая изобретательству и предоставляющая доступ к инструментам цифрового производства.
            Первый фаблаб в MIT был открыт в 2001 году. По состоянию на 2023 год в мире функционирует 2134 фаблаба.

            ЦМИТы (Центры молодежного инновационного творчества) - российский аналог фаблабов, созданный в рамках деятельности Фонда содействия инновациям.
            Основные направления: инновационная экономика страны и просветительский проект, расширяющий возможности образования участников.""",
            subject="Инновации",
            author="Земцов Д.И."
        ),
        Methodic(
            title="Кружковое движение в России",
            content="""Исторические корни кружкового движения восходят к началу XX века. В 1908 году профессор Николай Жуковский создал 
            в Московском техническом училище Воздухоплавательный кружок, из которого вышли многие выдающиеся советские инженеры и конструкторы.

            Современное кружковое движение включает более 500,000 школьников, студентов и их наставников. 
            Ключевые принципы: поддержка инициативы, проектное мышление, разнообразие тематик и меритократическое управление.""",
            subject="Техническое образование",
            author="Андрюшков А.А."
        ),
        Methodic(
            title="Теория социальных полей в образовании",
            content="""Теория полей утверждает, что общество - это система взаимодействующих и вложенных друг в друга социальных полей. 
            Социальное поле - это устойчивая система правил игры, в которой игроки, обладая 'чувством игры', стремятся добиться лучшего положения.

            Сообщества практик будущего - это группы людей, объединенных общим интересом к передовым технологическим и социальным решениям, 
            общей деятельностью и обменом знаниями, но не включенных в устойчивое социальное поле.""",
            subject="Социология образования",
            author="Земцов Д.И."
        ),
        Methodic(
            title="Мейкеры против COVID-19",
            content="""Во время пандемии COVID-19 международная сеть фаблабов организовала движение 'Мейкеры против COVID', 
            которое обеспечило миллионы врачей средствами индивидуальной защиты. Российский сегмент движения за полгода работы 
            поставил врачам более 170,000 изделий, помощь получили 40% государственных больниц и 6% медиков России.

            Это демонстрирует способность сообществ технологических энтузиастов к конструктивному и масштабному социальному действию.""",
            subject="Социальные инновации",
            author="Кружковое движение НТИ"
        )
    ]

    for methodic in sample_methodics:
        db.add(methodic)

    db.commit()